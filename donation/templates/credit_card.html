<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>クレジットカード決済</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .cc-hero {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #fff6e6 0%, #ffd075 40%, #f28c28 100%);
    }
    .cc-hero .container {
      padding-top: 54px;
      padding-bottom: 54px;
      text-align: center;
    }
    .cc-wrap {
      max-width: 760px;
      margin: 0 auto;
    }
    .cert {
      margin-top: 12px;
      color: #5f4b3d;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn-donate[disabled] {
      opacity: 0.7;
      cursor: wait;
    }
    .error {
      margin-top: 14px;
      color: #b42318;
      font-weight: 700;
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <header class="cc-hero">
    <div class="light-rays"></div>
    <div class="container">
      <h1>クレジットカード決済</h1>
      <p>このページではカード番号を入力しません。Stripeの決済画面で入力します。</p>
      {% if certificate_no %}
      <p class="cert">証明書番号: {{ certificate_no }}</p>
      {% endif %}
    </div>
  </header>

  <section class="section bg-light">
    <div class="container cc-wrap">
      <div class="card">
        <p>数秒でStripe決済画面へ自動遷移します。遷移しない場合はボタンを押してください。</p>
        <div class="actions">
          <button class="btn-donate" id="checkout-btn" type="button">Stripe決済画面へ進む</button>
          <a class="btn-sub" href="/donation/">寄付ページへ戻る</a>
        </div>
        <p class="error" id="checkout-error"></p>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const receiptIdRaw = "{{ receipt_id|default('', true) }}".trim();
      const receiptId = receiptIdRaw ? Number(receiptIdRaw) : null;
      const certificateNo = "{{ certificate_no|default('', true) }}".trim();
      const btn = document.getElementById("checkout-btn");
      const error = document.getElementById("checkout-error");

      async function startCheckout() {
        error.textContent = "";
        if ((receiptId === null || !Number.isInteger(receiptId) || receiptId <= 0) && !certificateNo) {
          error.textContent = "決済情報が不足しています。寄付ページからやり直してください。";
          return;
        }

        btn.disabled = true;
        btn.textContent = "決済画面を準備中...";
        try {
          const res = await fetch("/donation/api/stripe/checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              receipt_id: Number.isInteger(receiptId) && receiptId > 0 ? receiptId : undefined,
              certificate_no: certificateNo || undefined
            })
          });
          const data = await res.json();
          if (!res.ok || !data.checkout_url) {
            throw new Error(data.error || "Checkoutの作成に失敗しました。");
          }
          window.location.href = data.checkout_url;
        } catch (e) {
          error.textContent = e.message || "決済画面の作成に失敗しました。";
          btn.disabled = false;
          btn.textContent = "Stripe決済画面へ進む";
        }
      }

      btn.addEventListener("click", startCheckout);
      startCheckout();
    })();
  </script>
</body>
</html>
